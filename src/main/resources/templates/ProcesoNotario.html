<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="refresh" content="15">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GestiÃ³n de Proceso - Notario</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #e9ecef; overflow-x: hidden; }
        .sidebar-info { min-height: 100vh; background-color: #2c3e50; color: white; padding: 25px; }
        .chat-container { height: 65vh; overflow-y: scroll; background: #ffffff; border: 1px solid #ced4da; padding: 20px; border-radius: 5px;}
        .msg { margin-bottom: 15px; padding: 10px 15px; border-radius: 15px; max-width: 75%; font-size: 0.95rem; }
        .msg-me { background-color: #0d6efd; color: white; margin-left: auto; text-align: right; border-bottom-right-radius: 2px; }
        .msg-other { background-color: #f1f3f5; color: #212529; margin-right: auto; border-bottom-left-radius: 2px; }
        .msg-info { font-size: 0.7rem; opacity: 0.8; margin-top: 5px; display: block; }
        .msg-me .msg-info { color: #e0e0e0; }
        .btn-agendar { background-color: #f39c12; border: none; color: white; font-weight: bold; }
        .btn-agendar:hover { background-color: #d68910; color: white; }
    </style>
</head>
<body>

<div class="row g-0">
    <div class="col-md-3 sidebar-info">
        <h4 class="mb-4">ðŸ“‹ Panel Notarial</h4>

        <div class="card bg-dark text-white border-secondary mb-4">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Cliente</h6>
                <h5 class="card-title" th:text="${tramite.cliente.nombre} + ' ' + ${tramite.cliente.apellido}"></h5>
                <p class="card-text small">DNI: <span th:text="${tramite.cliente.dni}"></span></p>
                <hr class="border-secondary">
                <h6 class="card-subtitle mb-2 text-muted">Servicio</h6>
                <p class="card-text fw-bold text-warning" th:text="${tramite.servicio.nombre}"></p>
            </div>
        </div>

        <div class="card bg-light text-dark">
            <div class="card-body">
                <h5 class="card-title mb-3">ðŸ“… Agendar ReuniÃ³n</h5>
                <form th:action="@{/proceso/agendarReunion}" method="post">
                    <input type="hidden" name="idTramite" th:value="${tramite.idTramite}">

                    <div class="mb-2">
                        <label class="form-label small fw-bold">Fecha y Hora</label>
                        <input type="datetime-local" class="form-control form-control-sm" name="fecha" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold">Tema / UbicaciÃ³n</label>
                        <input type="text" class="form-control form-control-sm" name="tema" placeholder="Ej: Zoom o Presencial" required>
                    </div>

                    <button type="submit" class="btn btn-agendar w-100 btn-sm">Confirmar Cita</button>
                </form>
            </div>
        </div>

        <div class="mt-5 text-center">
            <a href="/SistemaNotario?seccion=tramites" class="btn btn-outline-light w-100">â¬… Volver al Listado</a>
        </div>
    </div>

    <div class="col-md-9 p-4 d-flex flex-column" style="height: 100vh;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>Expediente #<span th:text="${tramite.idTramite}"></span></h3>
            <span class="badge bg-success px-3 py-2">Estado: Activo</span>
        </div>

        <div class="chat-container shadow-sm mb-3" id="chatBox">
            <div th:if="${mensajes.empty}" class="text-center text-muted mt-5">
                <p>Inicie la conversaciÃ³n o solicite documentos al cliente.</p>
            </div>

            <div th:each="m : ${mensajes}"
                 th:class="'msg ' + (${m.usuario.idUsuario == usuarioActual.idUsuario} ? 'msg-me' : 'msg-other')">

                <strong th:if="${m.usuario.idUsuario != usuarioActual.idUsuario}" class="d-block mb-1 small text-secondary">Cliente</strong>

                <div th:if="${m.contenido != null}" th:text="${m.contenido}" style="white-space: pre-wrap;"></div>

                <div th:if="${m.archivoUrl != null}" class="mt-2">
                    <a th:href="@{'/uploads/chat/' + ${m.archivoUrl}}"
                       th:class="${m.usuario.idUsuario == usuarioActual.idUsuario} ? 'btn btn-sm btn-light text-primary' : 'btn btn-sm btn-secondary'"
                       target="_blank">
                        ðŸ“Ž Ver Archivo Adjunto
                    </a>
                </div>

                <span class="msg-info" th:text="${#temporals.format(m.fechaEnvio, 'dd/MM/yyyy HH:mm')}"></span>
            </div>
        </div>

        <div class="card bg-light border-0 shadow-sm">
            <div class="card-body">
                <form th:action="@{/proceso/mensaje}" method="post" enctype="multipart/form-data">
                    <input type="hidden" name="idTramite" th:value="${tramite.idTramite}">

                    <div class="input-group">
                        <input type="text" class="form-control" name="contenido" placeholder="Escriba respuesta, solicitud o notas..." autocomplete="off">
                        <input type="file" class="form-control" name="archivo" style="max-width: 300px;">
                        <button class="btn btn-primary px-4 fw-bold" type="submit">Enviar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    var chatBox = document.getElementById("chatBox");
    chatBox.scrollTop = chatBox.scrollHeight;
</script>

</body>
</html>