<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sistema de Gesti√≥n Notarial</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/stylesSistemaNotario.css" rel="stylesheet">
    <style>
        .thumb-servicio { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
        .sidebar { background-color: #000; min-height: 100vh; padding: 20px; width: 250px; position: fixed; }
        .sidebar a { display: block; padding: 10px; color: #bbb; text-decoration: none; border-radius: 4px; margin-bottom: 5px; }
        .sidebar a:hover, .sidebar a.active { background-color: #b8860b; color: white; }
        .content { margin-left: 250px; padding: 30px; }
        section { display: none; } /* Ocultar secciones por defecto */
    </style>
</head>
<body>

<div class="sidebar d-flex flex-column">
    <h4 class="text-white text-center mb-4">Notar√≠a Admin</h4>
    <a href="#" id="linkInicio" onclick="mostrarSeccion('inicio')">Inicio</a>
    <a href="#" id="linkBandeja" onclick="mostrarSeccion('solicitudes')">Bandeja de Entrada</a>
    <a href="#" id="linkTramites" onclick="mostrarSeccion('tramites')">Tr√°mites en Curso</a>
    <a href="#" id="linkServicios" onclick="mostrarSeccion('servicios')">Gesti√≥n Servicios</a>
    <a href="#" id="linkClientes" onclick="mostrarSeccion('clientes')">Gesti√≥n Clientes</a>
    <div class="flex-grow-1"></div>
    <a th:href="@{/logout}" class="logout text-danger fw-bold mt-3">Cerrar Sesi√≥n</a>
</div>

<div class="content">

    <section id="inicio" style="display: block;">
        <h1>Bienvenido, <strong th:text="${nombreNotario}" class="text-warning">Notario</strong></h1>
        <hr>
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card text-white bg-primary mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Solicitudes Pendientes</h5>
                        <h2 class="display-4" th:text="${solicitudesPendientes != null ? solicitudesPendientes.size() : 0}">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-success mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Tr√°mites Activos</h5>
                        <h2 class="display-4" th:text="${tramitesEnProceso != null ? tramitesEnProceso.size() : 0}">0</h2>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="solicitudes" class="mt-4">
        <h2 class="mb-3">Bandeja de Solicitudes (Pendientes)</h2>
        <div class="table-responsive shadow-sm rounded">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Tr√°mite</th>
                    <th>Descripci√≥n</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${solicitudesPendientes == null or solicitudesPendientes.empty}">
                    <td colspan="6" class="text-center p-4 text-muted">No hay solicitudes pendientes.</td>
                </tr>
                <tr th:each="t : ${solicitudesPendientes}">
                    <td th:text="${t.idTramite}"></td>
                    <td th:text="${t.fechaInicio}"></td>
                    <td th:text="${t.cliente.nombre} + ' ' + ${t.cliente.apellido}"></td>
                    <td th:text="${t.servicio.nombre}" class="fw-bold text-primary"></td>
                    <td th:text="${t.observaciones}"></td>
                    <td>
                        <a th:href="@{'/tramite/cambiarEstado/' + ${t.idTramite} + '/aceptado'}"
                           class="btn btn-sm btn-success me-1" onclick="return confirm('¬øAceptar solicitud?')">‚úî Aceptar</a>
                        <a th:href="@{'/tramite/cambiarEstado/' + ${t.idTramite} + '/rechazado'}"
                           class="btn btn-sm btn-danger" onclick="return confirm('¬øRechazar solicitud?')">‚úñ Rechazar</a>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>

    <section id="tramites" class="mt-4">
        <h2 class="mb-3">Gesti√≥n de Tr√°mites en Curso</h2>
        <div class="alert alert-info">
            <small>Solo se puede acceder al proceso si el cliente ha realizado el pago.</small>
        </div>
        <div class="table-responsive shadow-sm rounded">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>Servicio</th>
                    <th>Estado Pago</th>
                    <th class="text-center">Proceso</th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${tramitesEnProceso == null or tramitesEnProceso.empty}">
                    <td colspan="5" class="text-center p-4 text-muted">No hay tr√°mites en proceso.</td>
                </tr>
                <tr th:each="t : ${tramitesEnProceso}">
                    <td th:text="${t.idTramite}"></td>
                    <td th:text="${t.cliente.nombre} + ' ' + ${t.cliente.apellido}"></td>
                    <td th:text="${t.servicio.nombre}"></td>

                    <td>
                        <span th:if="${estadoPagos != null and estadoPagos.get(t.idTramite) == true}" class="badge bg-success">PAGADO</span>
                        <span th:unless="${estadoPagos != null and estadoPagos.get(t.idTramite) == true}" class="badge bg-danger">PENDIENTE</span>
                    </td>

                    <td class="text-center">
                        <div th:if="${estadoPagos != null and estadoPagos.get(t.idTramite) == true}">
                            <a th:href="@{'/proceso/notario/' + ${t.idTramite}}" class="btn btn-primary btn-sm fw-bold">
                                Ver Proceso üí¨
                            </a>
                        </div>
                        <div th:unless="${estadoPagos != null and estadoPagos.get(t.idTramite) == true}">
                            <button class="btn btn-secondary btn-sm" disabled title="Esperando pago del cliente">
                                üîí Bloqueado
                            </button>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>

    <section id="servicios" class="mt-4">
        <h2 class="mb-3">Gesti√≥n de Servicios</h2>
        <div class="mb-3">
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAgregarServicio">+ Nuevo Servicio</button>
            <a th:href="@{/servicios/exportar-excel}" class="btn btn-outline-success ms-2">Exportar Excel</a>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered align-middle" id="tablaServicios">
                <thead class="table-dark text-center">
                <tr>
                    <th>ID</th> <th>Img</th> <th>Nombre</th> <th>Costo</th> <th>Acciones</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="servicio : ${servicios}">
                    <td th:text="${servicio.idServicio}"></td>
                    <td class="text-center"><img th:if="${servicio.img}" th:src="@{'/uploads/servicios/' + ${servicio.img}}" class="thumb-servicio"></td>
                    <td th:text="${servicio.nombre}"></td>
                    <td th:text="'S/ ' + ${servicio.costo}"></td>
                    <td class="text-center">
                        <button class="btn btn-warning btn-sm" th:attr="onclick=|editarServicio(${servicio.idServicio})|">Editar</button>
                        <a th:href="@{'/servicios/eliminar/' + ${servicio.idServicio}}" class="btn btn-danger btn-sm" onclick="return confirm('¬øEliminar?')">Eliminar</a>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>

    <section id="clientes" class="mt-4">
        <h2 class="mb-3">Gesti√≥n de Clientes</h2>
        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead class="table-dark">
                <tr><th>ID</th> <th>Nombre</th> <th>DNI</th> <th>Acci√≥n</th></tr>
                </thead>
                <tbody>
                <tr th:each="cliente : ${clientes}">
                    <td th:text="${cliente.idCliente}"></td>
                    <td th:text="${cliente.nombre} + ' ' + ${cliente.apellido}"></td>
                    <td th:text="${cliente.dni}"></td>
                    <td><button class="btn btn-info btn-sm text-white" th:attr="onclick=|verUsuario(${cliente.idCliente})|">Ver Usuario</button></td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>

</div>

<div class="modal fade" id="modalAgregarServicio" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form th:action="@{/servicios/guardar}" method="post" enctype="multipart/form-data">
                <div class="modal-header bg-success text-white"><h5 class="modal-title">Nuevo Servicio</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-2"><label>Imagen</label><input type="file" class="form-control" name="imagenArchivo" required></div>
                    <div class="mb-2"><label>Nombre</label><input type="text" class="form-control" name="nombre" required></div>
                    <div class="mb-2"><label>Descripci√≥n</label><textarea class="form-control" name="descripcion" required></textarea></div>
                    <div class="mb-2"><label>Costo</label><input type="number" class="form-control" name="costo" step="0.01" required></div>
                </div>
                <div class="modal-footer"><button type="submit" class="btn btn-success">Guardar</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarServicio" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form th:action="@{/servicios/editar}" method="post" enctype="multipart/form-data">
                <div class="modal-header bg-warning"><h5 class="modal-title">Editar Servicio</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="editIdServicio" name="idServicio">
                    <div class="text-center mb-2"><img id="editPreview" style="width:80px;"></div>
                    <div class="mb-2"><label>Imagen</label><input type="file" class="form-control" name="imagenArchivo"></div>
                    <div class="mb-2"><label>Nombre</label><input type="text" class="form-control" id="editNombre" name="nombre" required></div>
                    <div class="mb-2"><label>Descripci√≥n</label><textarea class="form-control" id="editDescripcion" name="descripcion" required></textarea></div>
                    <div class="mb-2"><label>Costo</label><input type="number" class="form-control" id="editCosto" name="costo" step="0.01" required></div>
                </div>
                <div class="modal-footer"><button type="submit" class="btn btn-warning">Actualizar</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalUsuarioCliente" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white"><h5 class="modal-title">Usuario</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body"><p>ID: <span id="usuarioId"></span></p><p>Usuario: <span id="usuarioNombre"></span></p></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function mostrarSeccion(id) {
        document.querySelectorAll('section').forEach(sec => sec.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
        const link = document.getElementById('link' + id.charAt(0).toUpperCase() + id.slice(1));
        if(link) link.classList.add('active');
    }

    // Al cargar la p√°gina, verificamos si hay un par√°metro 'seccion' en la URL
    document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        const seccion = params.get("seccion") || "inicio";
        mostrarSeccion(seccion);
    });

    function editarServicio(id) {
        fetch('/servicios/editar/' + id).then(r => r.json()).then(data => {
            document.getElementById('editIdServicio').value = data.idServicio;
            document.getElementById('editNombre').value = data.nombre;
            document.getElementById('editDescripcion').value = data.descripcion;
            document.getElementById('editCosto').value = data.costo;
            document.getElementById('editPreview').src = data.img ? '/uploads/servicios/' + data.img : '';
            new bootstrap.Modal(document.getElementById('modalEditarServicio')).show();
        });
    }

    function verUsuario(id) {
        fetch('/clientes/usuario/' + id).then(r => r.json()).then(data => {
            document.getElementById('usuarioId').innerText = data ? data.idUsuario : '-';
            document.getElementById('usuarioNombre').innerText = data ? data.nombreUsuario : '-';
            new bootstrap.Modal(document.getElementById('modalUsuarioCliente')).show();
        });
    }
</script>
</body>
</html>