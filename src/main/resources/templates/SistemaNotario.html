<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sistema de Gesti√≥n Notarial</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            background-color: #f4f6f9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }

        .sidebar {
            width: 250px;
            background-color: #000;
            color: #fff;
            display: flex;
            flex-direction: column;
            padding: 20px;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            box-shadow: 2px 0 5px rgba(0,0,0,0.5);
        }

        .sidebar a {
            color: #bbb;
            text-decoration: none;
            padding: 12px 15px;
            border-radius: 4px;
            margin-bottom: 8px;
            display: block;
            transition: all 0.3s ease;
        }

        .sidebar a:hover, .sidebar a.active {
            background-color: #b8860b;
            color: #fff;
            padding-left: 20px;
        }

        .sidebar a.logout {
            margin-top: auto;
            background-color: #dc3545;
            color: white;
            text-align: center;
        }

        .content {
            margin-left: 250px;
            padding: 30px;
            width: calc(100% - 250px);
            min-height: 100vh;
        }

        .card {
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .thumb-servicio {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
        }

        .filter-container {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        section {
            display: none;
        }
    </style>
</head>
<body>

<div class="sidebar">
    <h3 class="text-center mb-4 text-warning">Notar√≠a</h3>
    <a href="#" onclick="mostrarSeccion('inicio')" id="linkInicio">Inicio</a>
    <a href="#" onclick="mostrarSeccion('solicitudes')" id="linkSolicitudes">Bandeja Solicitudes</a>
    <a href="#" onclick="mostrarSeccion('tramites')" id="linkTramites">Tr√°mites en Curso</a>
    <a href="#" onclick="mostrarSeccion('clientes')" id="linkClientes">Clientes</a>
    <a href="#" onclick="mostrarSeccion('servicios')" id="linkServicios">Servicios</a>
    <div class="flex-grow-1"></div>
    <form th:action="@{/logout}" method="post" style="display: block; width: 100%;">
        <button type="submit" class="btn btn-danger w-100 mt-3">Cerrar Sesi√≥n</button>
    </form>
</div>

<div class="content">

    <section id="inicio" style="display: block;">
        <div class="card p-5">
            <h1 class="mb-3">Bienvenido, <strong class="text-warning" th:text="${nombreNotario}">Notario</strong></h1>
            <p class="lead">Sistema de Gesti√≥n Notarial Integrado.</p>
            <hr>
            <div class="row mt-4">
                <div class="col-md-4">
                    <div class="card bg-primary text-white p-3 mb-3">
                        <h5>Solicitudes Pendientes</h5>
                        <h2 th:text="${solicitudesPendientes != null ? solicitudesPendientes.size() : 0}">0</h2>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success text-white p-3 mb-3">
                        <h5>Tr√°mites en Curso</h5>
                        <h2 th:text="${tramitesEnProceso != null ? tramitesEnProceso.size() : 0}">0</h2>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="solicitudes">
        <h2 class="mb-4">Bandeja de Solicitudes (Pendientes)</h2>

        <div class="filter-container row g-2">
            <div class="col-md-8">
                <input type="text" class="form-control" id="buscarSolicitud" onkeyup="filtrarTabla('tablaSolicitudes', this.value)" placeholder="üîç Buscar por cliente, descripci√≥n...">
            </div>
            <div class="col-md-4">
                <select class="form-select" onchange="filtrarPorColumna('tablaSolicitudes', 2, this.value)">
                    <option value="">Todos los Servicios</option>
                    <option th:each="s : ${servicios}" th:value="${s.nombre}" th:text="${s.nombre}"></option>
                </select>
            </div>
        </div>

        <div class="card p-3">
            <div class="table-responsive">
                <table class="table table-hover align-middle" id="tablaSolicitudes">
                    <thead class="table-dark text-center">
                    <tr>
                        <th>Fecha</th>
                        <th>Cliente</th>
                        <th>Tr√°mite</th>
                        <th>Descripci√≥n</th>
                        <th>Acciones</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${solicitudesPendientes == null or solicitudesPendientes.empty}">
                        <td colspan="5" class="text-center p-4">No hay solicitudes pendientes.</td>
                    </tr>
                    <tr th:each="t : ${solicitudesPendientes}">
                        <td th:text="${t.fechaInicio}"></td>
                        <td th:text="${t.cliente.nombre} + ' ' + ${t.cliente.apellido}"></td>
                        <td th:text="${t.servicio.nombre}" class="fw-bold text-primary"></td>
                        <td th:text="${t.observaciones}"></td>
                        <td class="text-center">
                            <a th:href="@{'/tramite/cambiarEstado/' + ${t.idTramite} + '/aceptado'}"
                               class="btn btn-sm btn-success"
                               onclick="confirmarAccion(event, this.href, '¬øAceptar Solicitud?', 'El tr√°mite pasar√° a estado Aceptado.', 'S√≠, aceptar', '#198754')">
                                ‚úî Aceptar
                            </a>
                            <a th:href="@{'/tramite/cambiarEstado/' + ${t.idTramite} + '/rechazado'}"
                               class="btn btn-sm btn-danger"
                               onclick="confirmarAccion(event, this.href, '¬øRechazar Solicitud?', 'Esta acci√≥n es irreversible.', 'S√≠, rechazar', '#dc3545')">
                                ‚úñ Rechazar
                            </a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <section id="tramites">
        <h2 class="mb-4">Tr√°mites en Curso</h2>

        <div class="filter-container row g-2">
            <div class="col-md-8">
                <input type="text" class="form-control" id="buscarTramite" onkeyup="filtrarTabla('tablaTramites', this.value)" placeholder="üîç Buscar tr√°mite, cliente...">
            </div>
            <div class="col-md-4">
                <select class="form-select" onchange="filtrarPorEstadoPago(this.value)">
                    <option value="">Todos los Estados de Pago</option>
                    <option value="Ver Proceso">Pagado (Ver Proceso)</option>
                    <option value="Pendiente Pago">Pendiente de Pago</option>
                </select>
            </div>
        </div>

        <div class="card p-3">
            <div class="table-responsive">
                <table class="table table-hover align-middle" id="tablaTramites">
                    <thead class="table-dark text-center">
                    <tr>
                        <th>Cliente</th>
                        <th>Servicio</th>
                        <th>Estado Tr√°mite</th>
                        <th>Estado Pago</th>
                        <th>Gesti√≥n</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${tramitesEnProceso == null or tramitesEnProceso.empty}">
                        <td colspan="5" class="text-center p-4">No hay tr√°mites en curso.</td>
                    </tr>
                    <tr th:each="t : ${tramitesEnProceso}">
                        <td th:text="${t.cliente.nombre} + ' ' + ${t.cliente.apellido}"></td>
                        <td th:text="${t.servicio.nombre}"></td>
                        <td class="text-center">
                            <span class="badge bg-info text-dark" th:text="${t.estado}"></span>
                        </td>

                        <td class="text-center columna-pago">
                            <div th:if="${estadoPagos != null and estadoPagos.get(t.idTramite) == true}">
                                <a th:href="@{'/proceso/notario/' + ${t.idTramite}}" class="btn btn-primary btn-sm fw-bold">
                                    Ver Proceso üí¨
                                </a>
                            </div>

                            <div th:unless="${estadoPagos != null and estadoPagos.get(t.idTramite) == true}">
                                <button class="btn btn-secondary btn-sm" disabled title="Esperando pago del cliente">
                                    üîí Pendiente Pago
                                </button>
                            </div>
                        </td>

                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-secondary">Detalles</button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <section id="servicios">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Gesti√≥n de Servicios</h2>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAgregarServicio">+ Nuevo Servicio</button>
        </div>

        <div class="filter-container">
            <input type="text" class="form-control" onkeyup="filtrarTabla('tablaServicios', this.value)" placeholder="üîç Buscar servicio...">
        </div>

        <div class="card p-3">
            <div class="table-responsive">
                <table class="table table-hover align-middle" id="tablaServicios">
                    <thead class="table-dark">
                    <tr>
                        <th>Imagen</th>
                        <th>Nombre</th>
                        <th>Descripci√≥n</th>
                        <th>Costo</th>
                        <th>Acciones</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="servicio : ${servicios}">
                        <td>
                            <img th:if="${servicio.img != null}" th:src="@{'/uploads/servicios/' + ${servicio.img}}" class="thumb-servicio">
                        </td>
                        <td th:text="${servicio.nombre}"></td>
                        <td th:text="${servicio.descripcion}"></td>
                        <td th:text="'S/ ' + ${servicio.costo}"></td>
                        <td>
                            <button class="btn btn-sm btn-warning" th:attr="onclick=|editarServicio(${servicio.idServicio})|">Editar</button>
                            <a th:href="@{'/servicios/eliminar/' + ${servicio.idServicio}}"
                               class="btn btn-sm btn-danger"
                               onclick="confirmarAccion(event, this.href, '¬øEliminar Servicio?', 'Se borrar√° permanentemente.', 'S√≠, eliminar', '#dc3545')">
                                Eliminar
                            </a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <section id="clientes">
        <h2 class="mb-4">Directorio de Clientes</h2>

        <div class="filter-container">
            <input type="text" class="form-control" onkeyup="filtrarTabla('tablaClientes', this.value)" placeholder="üîç Buscar cliente por nombre, DNI...">
        </div>

        <div class="card p-3">
            <div class="table-responsive">
                <table class="table table-striped" id="tablaClientes">
                    <thead class="table-dark">
                    <tr>
                        <th>Nombre</th> <th>Apellido</th> <th>DNI</th> <th>Usuario</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="cliente : ${clientes}">
                        <td th:text="${cliente.nombre}"></td>
                        <td th:text="${cliente.apellido}"></td>
                        <td th:text="${cliente.dni}"></td>
                        <td>
                            <button class="btn btn-sm btn-info text-white" th:attr="onclick=|verUsuario(${cliente.idCliente})|">Ver Usuario</button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

</div>

<div class="modal fade" id="modalAgregarServicio" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form th:action="@{/servicios/guardar}" method="post" th:object="${servicio}" enctype="multipart/form-data">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Nuevo Servicio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3"><label>Imagen</label><input type="file" class="form-control" name="imagenArchivo" accept="image/*" required></div>
                    <div class="mb-3"><label>Nombre</label><input type="text" class="form-control" th:field="*{nombre}" required></div>
                    <div class="mb-3"><label>Descripci√≥n</label><textarea class="form-control" th:field="*{descripcion}" required></textarea></div>
                    <div class="mb-3"><label>Costo</label><input type="number" class="form-control" step="0.01" th:field="*{costo}" required></div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarServicio" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form th:action="@{/servicios/editar}" method="post" enctype="multipart/form-data">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">Editar Servicio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editIdServicio" name="idServicio">
                    <div class="text-center mb-3"><img id="editPreview" src="" style="width:80px;height:80px;object-fit:cover;"></div>
                    <div class="mb-3"><label>Imagen</label><input type="file" class="form-control" name="imagenArchivo"></div>
                    <div class="mb-3"><label>Nombre</label><input type="text" class="form-control" id="editNombre" name="nombre" required></div>
                    <div class="mb-3"><label>Descripci√≥n</label><textarea class="form-control" id="editDescripcion" name="descripcion" required></textarea></div>
                    <div class="mb-3"><label>Costo</label><input type="number" class="form-control" id="editCosto" name="costo" step="0.01" required></div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-warning">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalUsuarioCliente" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white"><h5 class="modal-title">Info Usuario</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <p><strong>Usuario:</strong> <span id="usuarioNombre"></span></p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function mostrarSeccion(id) {
        document.querySelectorAll('section').forEach(sec => sec.style.display = 'none');
        const sec = document.getElementById(id);
        if(sec) sec.style.display = 'block';

        document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
        const link = document.getElementById('link' + id.charAt(0).toUpperCase() + id.slice(1));
        if(link) link.classList.add('active');
    }

    document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        const seccion = params.get("seccion") || "inicio";
        mostrarSeccion(seccion);

        if (params.get('edit') === 'success') {
            const Toast = Swal.mixin({
                toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true
            });
            Toast.fire({ icon: 'success', title: 'Operaci√≥n realizada correctamente' });
        }
    });


    function filtrarTabla(tablaId, texto) {
        const table = document.getElementById(tablaId);
        const tr = table.getElementsByTagName("tr");
        const filtro = texto.toLowerCase();

        for (let i = 1; i < tr.length; i++) {
            let visible = false;
            const td = tr[i].getElementsByTagName("td");
            for (let j = 0; j < td.length; j++) {
                if (td[j]) {
                    if (td[j].textContent.toLowerCase().indexOf(filtro) > -1) {
                        visible = true;
                        break;
                    }
                }
            }
            tr[i].style.display = visible ? "" : "none";
        }
    }

    function filtrarPorColumna(tablaId, indiceColumna, valor) {
        const table = document.getElementById(tablaId);
        const tr = table.getElementsByTagName("tr");
        const filtro = valor.toLowerCase();

        for (let i = 1; i < tr.length; i++) {
            const td = tr[i].getElementsByTagName("td")[indiceColumna]; // Columna espec√≠fica
            if (td) {
                const textoCelda = td.textContent.toLowerCase();
                tr[i].style.display = (valor === "" || textoCelda.indexOf(filtro) > -1) ? "" : "none";
            }
        }
    }

    function filtrarPorEstadoPago(valor) {
        const table = document.getElementById('tablaTramites');
        const tr = table.getElementsByTagName("tr");
        const indicePago = 3;

        for (let i = 1; i < tr.length; i++) {
            const td = tr[i].getElementsByTagName("td")[indicePago];
            if (td) {
                const contenido = td.textContent || td.innerText;
                if (valor === "") {
                    tr[i].style.display = "";
                } else if (contenido.includes("Ver Proceso") && valor === "Ver Proceso") {
                    tr[i].style.display = "";
                } else if (contenido.includes("Pendiente Pago") && valor === "Pendiente Pago") {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }

    function confirmarAccion(event, url, titulo, texto, btnConfirmar, colorBtn) {
        event.preventDefault();
        Swal.fire({
            title: titulo,
            text: texto,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: colorBtn,
            cancelButtonColor: '#6c757d',
            confirmButtonText: btnConfirmar,
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = url;
            }
        });
    }

    function editarServicio(id) {
        fetch('/servicios/editar/' + id)
            .then(r => r.json())
            .then(data => {
                document.getElementById('editIdServicio').value = data.idServicio;
                document.getElementById('editNombre').value = data.nombre;
                document.getElementById('editDescripcion').value = data.descripcion;
                document.getElementById('editCosto').value = data.costo;
                document.getElementById('editPreview').src = data.img ? '/uploads/servicios/' + data.img : '';
                new bootstrap.Modal(document.getElementById('modalEditarServicio')).show();
            });
    }

    function verUsuario(id) {
        fetch('/clientes/usuario/' + id)
            .then(r => r.json())
            .then(data => {
                document.getElementById('usuarioNombre').innerText = data ? data.nombreUsuario : '-';
                new bootstrap.Modal(document.getElementById('modalUsuarioCliente')).show();
            });
    }
</script>

</body>
</html>